---
title: "CINmetrics and clinical variables analysis"
author: "Sasha Thalluri"
date: "8/23/2021"
output: html_document
---

This R Markdown will have the analysis to compare the CINmetrics to clinical variables. We compare the CINmetrics to metastasis, lymph node inclusion, and tumor stage (TNM) data. The output of this document will include U-test calculations between the CINmetrics and the separate TNM stages.

-------------------------------------------------------------------

# CINmetrics with Clinical Variables
```{r}
# These are the packages that are used throughout this R Markdown
library(tidyverse)
library(here)
library(rstatix)
library(devtools)
library(ggpubr)
library(dplyr)
library(ggstatsplot)
```
## CINmetrics with Clinical Variables Dataframe
```{r}
## Here, we load the data with all of the CINmetrics data that was created in the CINmetrics_analysis.Rmd and and all of the CNV data that was created in tcga_data.Rmd
all.cinmetrics.df <- read.csv(here("data", "processed", "all_cinmetrics_df.csv"))
all.cancer.df <- read.csv(here("data", "processed", "all_cancer_df.csv"))

## This function takes the all.cinmetrics.df and the all.cancer.df and creates a dataframe that will also have the clinical variables (tumor stage, nodal invasion, and metastasis information) associated by Patient ID
get_tnm <- function(all.cancer.df, all.cinmetrics.df){
  # Joining clinical variables to the CINmetrics dataframe and filtering out the cancer projects without TNM data
  all.tnm.df <- inner_join(all.cinmetrics.df, all.cancer.df[,c(7,13:16)], by = c("sample_id" = "Sample")) %>% unique(.) %>% filter(!project %in% c("TCGA-GBM", "TCGA-LAML", "TCGA-OV", "TCGA-THYM", "TCGA-UCS", "TCGA-DLBC", "TCGA-PCPG", "TCGA-UCEC", "TCGA-SARC", "TCGA-PRAD", "TCGA-LGG")) 
  # We store the output as a csv
write.csv(all.tnm.df, file = here("data", "processed", "all_tnm_df.csv"), row.names = FALSE)
  return(all.tnm.df)
}

# Obtaining a dataframe with all of the CINmetrics and TNM data for each sample across the 22 cancer types in TCGA
all.tnm.df <- get_tnm(all.cancer.df, all.cinmetrics.df)
```

## U-tests for CINmetrics and TNM Stages
```{r}
## We create vectors with the 22 cancer names and 6 CINmetrics to loop through 
cancer.project <- c("TCGA-KIRC", "TCGA-BRCA", "TCGA-MESO", "TCGA-READ", "TCGA-KIRP", "TCGA-PAAD", "TCGA-ACC", "TCGA-CESC", "TCGA-ESCA", "TCGA-KICH", "TCGA-UVM", "TCGA-SKCM", "TCGA-COAD", "TCGA-LUSC", "TCGA-HNSC", "TCGA-TGCT", "TCGA-THCA", "TCGA-LIHC", "TCGA-BLCA", "TCGA-CHOL", "TCGA-STAD", "TCGA-LUAD")
metrics <- c("tai", "modified_tai", "cna","base_segments", "break_points", "fga")

## This function takes the all.tnm.df and performs a Mann-Whitney U-test on each of the stages depending on TNM for tumor samples
get_utest_data <- function(all.tnm.df, cancer.project, tnm.category, metrics, file.name){
  if(tnm.category == "tumor.stage"){
    # We create an empty dataframe to store the U-test data
    tumor.stage.utest.df <- data.frame(.y. = character(),
                        group1 = character(),
                        group2 = character(),
                        n1 = numeric(),
                        n2 = numeric(),
                        p = numeric(),
                        p.signif = character(),
                        p.adj = numeric(),
                        p.adj.signif = character())
    
    for(i in 1:length(cancer.project)){
    tumor.stage.df <- subset(all.tnm.df, project == cancer.project[i])
    
    # We filter  the dataframe to only have the tumor stages and tumor samples we want included in the analysis
    tumor.stage.df <- tumor.stage.df %>% select(!c(ajcc_pathologic_m, ajcc_pathologic_n, ajcc_clinical_m)) %>% filter(!(ajcc_pathologic_t %in% c("TX", "Tis", "T0")) & sample_type %in% c("Metastatic", "Primary Blood Derived Cancer", "Primary Tumor", "Recurrent Tumor", "Additional - New Primary", "Primary Blood Derived Cancer - Peripheral Blood")) %>% drop_na(ajcc_pathologic_t)
    tumor.stage.df$ajcc_pathologic_t <- ifelse(tumor.stage.df$ajcc_pathologic_t %in% c("T1a", "T1a1", "T1b", "T1b2", "T1b1", "T1c"), "T1", ifelse(tumor.stage.df$ajcc_pathologic_t %in% c("T2a", "T2b", "T2c", "T2a2", "T2a1", "T2a2"), "T2", ifelse(tumor.stage.df$ajcc_pathologic_t %in% c("T3a", "T3b", "T3c"), "T3", ifelse(tumor.stage.df$ajcc_pathologic_t %in% c("T4a", "T4b", "T4c", "T4d", "T4e"), "T4", tumor.stage.df$ajcc_pathologic_t))))
    
    for(j in metrics){
    # We performed the Mann-Whitney U-test (otherwise known as the Wilcoxon test)
    cinmetrics <- tumor.stage.df[, j]
    tumor_stage <- factor(tumor.stage.df[,"ajcc_pathologic_t"], levels = c("T1", "T2", "T3", "T4"))
    cinmetrics.stage.df <- cbind(cinmetrics, tumor_stage) %>% as.data.frame(.)
    utest.results <- cinmetrics.stage.df %>% wilcox_test(cinmetrics ~ tumor_stage, paired = FALSE, p.adjust.method = "bonferroni")
    utest.results$project <- cancer.project[i]
    utest.results$cin <- j
    tumor.stage.utest.df <- rbind(tumor.stage.utest.df, utest.results)
    }
    }
    
    # We changed the group names in the U-test results to match the tumor stage
    tumor.stage.utest.df <- tumor.stage.utest.df %>% select(cin, project, group1, group2, n1, n2, statistic, p, p.adj, p.adj.signif)
    tumor.stage.utest.df$group1 <- ifelse(tumor.stage.utest.df$group1 %in% "1", "T1", ifelse(tumor.stage.utest.df$group1 %in% "2", "T2", ifelse(tumor.stage.utest.df$group1 %in% "3", "T3", ifelse(tumor.stage.utest.df$group1 %in% "4", "T4", tumor.stage.utest.df$group1))))
    tumor.stage.utest.df$group2 <- ifelse(tumor.stage.utest.df$group2 %in% "1", "T1", ifelse(tumor.stage.utest.df$group2 %in% "2", "T2", ifelse(tumor.stage.utest.df$group2 %in% "3", "T3", ifelse(tumor.stage.utest.df$group2 %in% "4", "T4", tumor.stage.utest.df$group2))))
    
    # We will store this output in a CSV file 
    write.csv(tumor.stage.utest.df, file = here("data", "processed", file.name), row.names = FALSE)
    return(tumor.stage.utest.df)
    
  } 
  if(tnm.category == "metastasis"){
    # We create empty data frames to store the U-test data
    metastasis.utest.df <- data.frame(.y. = character(),
                        group1 = character(),
                        group2 = character(),
                        n1 = numeric(),
                        n2 = numeric(),
                        p = numeric(),
                        project = character(), 
                        cin = character())
    acc.metastasis.utest.df <- data.frame(.y. = character(),
                        group1 = character(),
                        group2 = character(),
                        n1 = numeric(),
                        n2 = numeric(),
                        p = numeric(),
                        project = character(), 
                        cin = character())
    
    for(i in 1:length(cancer.project)){
    if(cancer.project[i] != "TCGA-ACC"){
    # We separated the analyses for metastasis data to be dependent on the column it uses
    metastasis.df <- subset(all.tnm.df, project == cancer.project[i])
    
    # We filter the data frame to only have the metastasis data we want included in the analysis
    metastasis.df <- metastasis.df %>% select(!c(ajcc_pathologic_t, ajcc_pathologic_n, ajcc_clinical_m)) %>% filter(!(ajcc_pathologic_m %in% "MX") & sample_type %in% c("Metastatic", "Primary Blood Derived Cancer", "Primary Tumor", "Recurrent Tumor", "Additional - New Primary", "Primary Blood Derived Cancer - Peripheral Blood")) %>% drop_na()
    metastasis.df$ajcc_pathologic_m <- ifelse(metastasis.df$ajcc_pathologic_m %in% c("cM0 (i+)"), "M0", ifelse(metastasis.df$ajcc_pathologic_m %in% c("M1a", "M1b", "M1c"), "M1", metastasis.df$ajcc_pathologic_m))
    
    for(j in metrics){
    # We performed the Mann-Whitney U-test (otherwise known as the Wilcoxon test)
    cinmetrics <- metastasis.df[, j]
    metastasis <- factor(metastasis.df[,"ajcc_pathologic_m"], levels = c("M0", "M1"))
    cinmetrics.metastasis.df <- cbind(cinmetrics, metastasis) %>% as.data.frame(.)
    utest.results <- 
      cinmetrics.metastasis.df %>% wilcox_test(cinmetrics ~ metastasis, p.adjust.method = "none")
  
    utest.results$project <- cancer.project[i]
    utest.results$cin <- j
    metastasis.utest.df <- rbind(metastasis.utest.df, utest.results)
    }
    }
     else{
    acc.metastasis.df <- subset(all.tnm.df, project == cancer.project[i])
    # We filter the data frame to only have the metastasis data we want included in the analysis
    acc.metastasis.df <- acc.metastasis.df %>% select(!c(ajcc_pathologic_t, ajcc_pathologic_n, ajcc_pathologic_m)) %>% filter(!(ajcc_clinical_m %in% "MX") & sample_type %in% c("Metastatic", "Primary Blood Derived Cancer", "Primary Tumor", "Recurrent Tumor", "Additional - New Primary", "Primary Blood Derived Cancer - Peripheral Blood")) %>% drop_na()
    acc.metastasis.df$ajcc_clinical_m <- ifelse(acc.metastasis.df$ajcc_clinical_m %in% c("cM0 (i+)"), "M0", ifelse(acc.metastasis.df$ajcc_clinical_m %in% c("M1a", "M1b", "M1c"), "M1", acc.metastasis.df$ajcc_clinical_m))
    
    for(j in metrics){
    # We performed the Mann-Whitney U-test (otherwise known as the Wilcoxon test)
    acc.cinmetrics <- acc.metastasis.df[, j]
   acc.metastasis <- factor(acc.metastasis.df[,"ajcc_clinical_m"], levels = c("M0", "M1"))
    acc.cinmetrics.metastasis.df <- cbind(acc.cinmetrics, acc.metastasis) %>% as.data.frame(.)
    acc.utest.results <- 
      acc.cinmetrics.metastasis.df %>% wilcox_test(acc.cinmetrics ~ acc.metastasis, p.adjust.method = "none")
    acc.utest.results$project <- cancer.project[i]
    acc.utest.results$cin <- j
    acc.metastasis.utest.df <- rbind(acc.metastasis.utest.df, acc.utest.results)
    }
     }
    }
    # We changed the group names in the U-test results to match the metastasis categories
    metastasis.utest.df <- metastasis.utest.df %>% select(cin, project, group1, group2, n1, n2, statistic, p)
   metastasis.utest.df$group1 <- ifelse(metastasis.utest.df$group1 %in% "1", "M0", ifelse(metastasis.utest.df$group1 %in% "2", "M1", metastasis.utest.df$group1))
   metastasis.utest.df$group2 <- ifelse(metastasis.utest.df$group2 %in% "1", "M0", ifelse(metastasis.utest.df$group2 %in% "2", "M1", metastasis.utest.df$group1))
   
   acc.metastasis.utest.df <- acc.metastasis.utest.df %>% select(cin, project, group1, group2, n1, n2, statistic, p)
   acc.metastasis.utest.df$group1 <- ifelse(acc.metastasis.utest.df$group1 %in% "1", "M0", ifelse(acc.metastasis.utest.df$group1 %in% "2", "M1", acc.metastasis.utest.df$group1))
   acc.metastasis.utest.df$group2 <- ifelse(acc.metastasis.utest.df$group2 %in% "1", "M0", ifelse(acc.metastasis.utest.df$group2 %in% "2", "M1", acc.metastasis.utest.df$group1))
   metastasis.utest.df <- rbind(metastasis.utest.df, acc.metastasis.utest.df)
   
   # We will store this output in a CSV file 
   write.csv(metastasis.utest.df, file = here("data", "processed", file.name), row.names = FALSE)
   return(metastasis.utest.df)
  }  
  if(tnm.category == "node"){
    # We created empty data frames to store the U-test data
    node.utest.df <- data.frame(.y. = character(),
                        group1 = character(),
                        group2 = character(),
                        n1 = numeric(),
                        n2 = numeric(),
                        statistic = numeric(),
                        p = numeric(),
                        project = character(), 
                        cin = character())
    node.adjusted.utest <- data.frame(.y. = character(),
                        group1 = character(),
                        group2 = character(),
                        n1 = numeric(),
                        n2 = numeric(),
                        p = numeric(),
                        p.signif = character(),
                        p.adj = numeric(),
                        p.adj.signif = character(),
                        project = character(),
                        cin = character())
    
    for(i in 1:length(cancer.project)){
    # We separated the analyses for node data to be dependent on the number of lymph node inclusion categories there are
      
    if(cancer.project[i] == "TCGA-ACC" || cancer.project[i] == "TCGA-CESC" || cancer.project[i] == "TCGA-CHOL" || cancer.project[i] == "TCGA-KIRC" || cancer.project[i] == "TCGA-LIHC" || cancer.project[i] == "TCGA-PAAD" || cancer.project[i] == "TCGA-THCA"){
    node.df <- subset(all.tnm.df, project == cancer.project[i])
    
    # We filtered the data frame to only have the node data we want included in the analysis
    node.df <- node.df %>% select(!c(ajcc_pathologic_t, ajcc_pathologic_m, ajcc_clinical_m)) %>% filter(!(ajcc_pathologic_n %in% "NX") & sample_type %in% c("Metastatic", "Primary Blood Derived Cancer", "Primary Tumor", "Recurrent Tumor", "Additional - New Primary", "Primary Blood Derived Cancer - Peripheral Blood")) %>% drop_na()
  
    node.df$ajcc_pathologic_n <- ifelse(node.df$ajcc_pathologic_n %in% c("N0 (i+)", "N0 (i-)", "N0 (mol+)"), "N0", ifelse(node.df$ajcc_pathologic_n %in% c("N1mi", "N1a", "N1b", "N1c"), "N1", ifelse(node.df$ajcc_pathologic_n %in% c("N2a", "N2b", "N2c"), "N2", ifelse(node.df$ajcc_pathologic_n %in% c("N3a", "N3b", "N3c"), "N3", node.df$ajcc_pathologic_n))))
    for(j in metrics){
    # We performed the Mann-Whitney U-test (otherwise known as the Wilcoxon test)
    cinmetrics <- node.df[, j]
    node <- factor(node.df[,"ajcc_pathologic_n"], levels = c("N0", "N1"))
    cinmetrics.node.df <- cbind(cinmetrics, node) %>% as.data.frame(.)
    utest.results <- 
      cinmetrics.node.df %>% wilcox_test(cinmetrics ~ node, p.adjust.method = "none")
    utest.results$project <- cancer.project[i]
    utest.results$cin <- j
    node.utest.df <- rbind(node.utest.df, utest.results)
    }
    }
      if(cancer.project[i] == "TCGA-COAD" || cancer.project[i] == "TCGA-KICH" || cancer.project[i] == "TCGA-KIRP" || cancer.project[i] == "TCGA-READ" || cancer.project[i] == "TCGA-TGCT" || cancer.project[i] == "TCGA-BLCA" || cancer.project[i] == "TCGA-BRCA" || cancer.project[i] == "TCGA-ESCA" || cancer.project[i] == "TCGA-HNSC" || cancer.project[i] == "TCGA-LUAD" || cancer.project[i] == "TCGA-LUSC" || cancer.project[i] == "TCGA-MESO" || cancer.project[i] == "TCGA-STAD" || cancer.project[i] == "TCGA-SKCM"){
        
    node.df <- subset(all.tnm.df, project == cancer.project[i])
    
    # we filtered the data frame to only have the node data we want included in the analysis
    node.df <- node.df %>% select(!c(ajcc_pathologic_t, ajcc_pathologic_m, ajcc_clinical_m)) %>% filter(!(ajcc_pathologic_n %in% "NX") & sample_type %in% c("Metastatic", "Primary Blood Derived Cancer", "Primary Tumor", "Recurrent Tumor", "Additional - New Primary", "Primary Blood Derived Cancer - Peripheral Blood")) %>% drop_na()
  
    node.df$ajcc_pathologic_n <- ifelse(node.df$ajcc_pathologic_n %in% c("N0 (i+)", "N0 (i-)", "N0 (mol+)"), "N0", ifelse(node.df$ajcc_pathologic_n %in% c("N1mi", "N1a", "N1b", "N1c"), "N1", ifelse(node.df$ajcc_pathologic_n %in% c("N2a", "N2b", "N2c"), "N2", ifelse(node.df$ajcc_pathologic_n %in% c("N3a", "N3b", "N3c"), "N3", node.df$ajcc_pathologic_n))))
    for(j in metrics){
    # We performed the Mann-Whitney U-test (otherwise known as the Wilcoxon test)
    cinmetrics <- node.df[, j]
    node <- factor(node.df[,"ajcc_pathologic_n"], levels = c("N0", "N1", "N2", "N3"))
    cinmetrics.node.df <- cbind(cinmetrics, node) %>% as.data.frame(.)
    utest.results <- 
      cinmetrics.node.df %>% 
      wilcox_test(cinmetrics ~ node, paired = FALSE, p.adjust.method = "bonferroni")
    utest.results$project <- cancer.project[i]
    utest.results$cin <- j
    node.adjusted.utest <- rbind(node.adjusted.utest, utest.results)
    }
      } 
      else{
    # Skipping over the cancers that does not have enough node data for U-tests (like TCGA-UVM)
        next
      }
    }
    # We combined both of the node U-test data frames
    node.utest.df <- node.utest.df %>% add_column(p.adj = NA) %>% add_column(p.adj.signif = NA) %>% select(cin, project, group1, group2, n1, n2, statistic, p, p.adj, p.adj.signif)
    node.adjusted.utest <- node.adjusted.utest %>% select(cin, project, group1, group2, n1, n2, statistic, p, p.adj, p.adj.signif)
    node.utest.df <- rbind(node.utest.df, node.adjusted.utest) %>% as.data.frame()
    
    # We changed the group names in the U-test results to match the node categories
   node.utest.df$group1 <- ifelse(node.utest.df$group1 %in% "1", "N0", ifelse(node.utest.df$group1 %in% "2", "N1", ifelse(node.utest.df$group1 %in% "3", "N2", node.utest.df$group1)))
   node.utest.df$group2 <- ifelse(node.utest.df$group2 %in% "2", "N1", ifelse(node.utest.df$group2 %in% "3", "N2", ifelse(node.utest.df$group2 %in% "4", "N3", node.utest.df$group1)))
   
   # We will store this output in a CSV file 
   write.csv(node.utest.df, file = here("data", "processed", file.name), row.names = FALSE)
   return(node.utest.df)
  }
  else{
    stop("Incorrect input for tnm.category. Make sure you pick 'tumor.stage', 'metastasis', or 'node'")
  }
  }
tumor.stage.utest.df <- get_utest_data(all.tnm.df, cancer.project, tnm.category = "tumor.stage", metrics, file.name = "tumor_stage_utest_df.csv")
metastasis.utest.df <- get_utest_data(all.tnm.df, cancer.project, tnm.category = "metastasis", metrics, file.name = "metastasis_utest_df.csv")
node.utest.df <- get_utest_data(all.tnm.df, cancer.project, tnm.category = "node", metrics, file.name = "node_utest_df.csv")


```

## Wilcox Bar Graphs of CINmetrics Values by Tumor Stage
```{r}
# ## Here, we load the data that was created in the previous code chunk for Wilcox bar graphs
metastasis.utest.df <- read.csv(here("data", "processed", "metastasis_utest_df.csv"))
node.utest.df <- read.csv(here("data", "processed", "node_utest_df.csv"))
tumor.stage.utest.df <- read.csv(here("data", "processed", "tumor_stage_utest_df.csv"))

# This function takes the dataframe with the p.values from the U-test results and creates bar graphs to compare across cancers. Note: There will be a red line on the graph which is showing the Bonferroni correction for the analysis
get_utest_graphs <- function(tnm.category, cancer.project){
  if(tnm.category == "tumor.stage"){
    # Filter for T1 and T4 and -Log10 transformation of p values
    filtered.tumor.stage.utest <- filter(tumor.stage.utest.df, group1 == "T1" & group2 == "T4")
    filtered.tumor.stage.df <- filtered.tumor.stage.utest %>% select(cin, project, group1, group2)
    # Creating a function to calculate the -log10 transformation of the p-values to input into sapply
    neglog10 <- function(x){
      neglog10 <- -log10(x)
      return(neglog10)
    }
    
    log.tumor.stage.utest <- filtered.tumor.stage.utest %>% select(p) %>% sapply(., neglog10)
    log.tumor.stage.utest <- cbind(filtered.tumor.stage.df, log.tumor.stage.utest)
    log.tumor.stage.utest$project <- str_remove(log.tumor.stage.utest$project, "TCGA-")
    
    # Base Segments Plot
    base.segments.utest <- filter(log.tumor.stage.utest, cin == "base_segments")
    base.segments.barplot <- ggbarplot(base.segments.utest,
                                       x = "project", y = "p",
                                       rotate = TRUE,
                                       xlab = "Cancer",
                                       ylab = "-Log10 p-value (T4 v. T1)",
                                       width = 0.4,
                                       sort.val = "asc",
                                       fill = "black",
                                       title = " ",
                                       font.main = c(11, "bold"),
                                       font.x = c(10, "bold"),
                                       font.y = c(10, "bold"),
                                       font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(4, "bold"),) + geom_hline(yintercept = -log10(0.05/(length(base.segments.utest$p))), linetype = "dashed", color = "red") 
    # Breakpoints Plot
    break.points.utest <- filter(log.tumor.stage.utest, cin == "break_points")
    break.points.barplot <- ggbarplot(break.points.utest,
                                       x = "project", y = "p",
                                       rotate = TRUE,
                                       xlab = "Cancer",
                                       ylab = "-Log10 p-value (T4 v. T1)",
                                       width = 0.4,
                                       sort.val = "asc",
                                       fill = "black",
                                       title = " ",
                                       font.main = c(11, "bold"),
                                       font.x = c(10, "bold"),
                                       font.y = c(10, "bold"),
                                       font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(4, "bold"),) + geom_hline(yintercept = -log10(0.05/(length(break.points.utest$p))), linetype = "dashed", color = "red")
    # TAI bar plot
    tai.utest <- filter(log.tumor.stage.utest, cin == "tai")
    tai.barplot <- ggbarplot(tai.utest,
                                       x = "project", y = "p",
                                       rotate = TRUE,
                                       xlab = "Cancer",
                                       ylab = "-Log10 p-value (T4 v. T1)",
                                       width = 0.4,
                                       sort.val = "asc",
                                       fill = "black",
                                       title = " ",
                                       font.main = c(11, "bold"),
                                       font.x = c(10, "bold"),
                                       font.y = c(10, "bold"),
                                       font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(4, "bold"),) + geom_hline(yintercept = -log10(0.05/(length(tai.utest$p))), linetype = "dashed", color = "red")
    # FGA bar plot
    fga.utest <- filter(log.tumor.stage.utest, cin == "fga")
    fga.barplot <- ggbarplot(fga.utest,
                                       x = "project", y = "p",
                                       rotate = TRUE,
                                       xlab = "Cancer",
                                       ylab = "-Log10 p-value (T4 v. T1)",
                                       width = 0.4,
                                       sort.val = "asc",
                                       fill = "black",
                                       title = " ",
                                       font.main = c(11, "bold"),
                                       font.x = c(10, "bold"),
                                       font.y = c(10, "bold"),
                                       font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(4, "bold"),) + geom_hline(yintercept = -log10(0.05/(length(fga.utest$p))), linetype = "dashed", color = "red")
    # CNA bar plot
    cna.utest <- filter(log.tumor.stage.utest, cin == "cna")
    cna.barplot <- ggbarplot(cna.utest,
                                       x = "project", y = "p",
                                       rotate = TRUE,
                                       xlab = "Cancer",
                                       ylab = "-Log10 p-value (T4 v. T1)",
                                       width = 0.4,
                                       sort.val = "asc",
                                       fill = "black",
                                       title = " ",
                                       font.main = c(11, "bold"),
                                       font.x = c(10, "bold"),
                                       font.y = c(10, "bold"),
                                       font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(4, "bold"),) + geom_hline(yintercept = -log10(0.05/(length(cna.utest$p))), linetype = "dashed", color = "red")
   
     # Modified TAI bar plot
    modified.tai.utest <- filter(log.tumor.stage.utest, cin == "modified_tai")
    modified.tai.barplot <- ggbarplot(modified.tai.utest,
                                       x = "project", y = "p",
                                       rotate = TRUE,
                                       xlab = "Cancer",
                                       ylab = "-Log10 p-value (T4 v. T1)",
                                       width = 0.4,
                                       sort.val = "asc",
                                       fill = "black",
                                       title = " ",
                                       font.main = c(11, "bold"),
                                       font.x = c(10, "bold"),
                                       font.y = c(10, "bold"),
                                       font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(4, "bold"),) + geom_hline(yintercept = -log10(0.05/(length(modified.tai.utest$p))), linetype = "dashed", color = "red")
    
    # Combining Separate CINmetrics Plots into one Tumor Stage Bar Plot
    tumor.stage.barplot <- ggarrange(base.segments.barplot + rremove("xlab"),
                                     fga.barplot + rremove("xlab"),
                                     break.points.barplot + rremove("xlab"),
                                     cna.barplot + rremove("xlab"),
                                     tai.barplot + rremove("xlab"), modified.tai.barplot + rremove("xlab"),
                                     ncol = 1, nrow = 6)
    tumor.stage.barplot <- annotate_figure(tumor.stage.barplot, 
                    bottom = text_grob("-Log10 p-value (T4 v. T1)"))
    return(tumor.stage.barplot)
                                  
  }
  
  if(tnm.category == "metastasis"){
    # Filter for T1 and T4 and -Log10 transformation of p values
    filtered.metastasis.utest <- filter(metastasis.utest.df, group1 == "M0" & group2 == "M1")
    filtered.metastasis.df<- filtered.metastasis.utest %>% select(cin, project, group1, group2)
    # Creating a function to calculate the -log10 transformation of the p-values to input into sapply
    neglog10 <- function(x){
      neglog10 <- -log10(x)
      return(neglog10)
    }
    log.metastasis.utest <- filtered.metastasis.utest %>% select(p) %>% sapply(., neglog10)
    log.metastasis.utest <- cbind(filtered.metastasis.df, log.metastasis.utest)
    log.metastasis.utest$project <- str_remove(log.metastasis.utest$project, "TCGA-")
    
    # Base Segments Plot
    base.segments.utest <- filter(log.metastasis.utest, cin == "base_segments")
    base.segments.barplot <- ggbarplot(base.segments.utest,
                                       x = "project", y = "p",
                                       rotate = TRUE,
                                       xlab = "Cancer",
                                       ylab = "-Log10 p-value (M1 v. M0)",
                                       width = 0.4,
                                       sort.val = "asc",
                                       fill = "black",
                                       title = "Base Segments",
                                       font.main = c(11, "bold"),
                                       font.x = c(10, "bold"),
                                       font.y = c(10, "bold"),
                                       font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(4, "bold"),) + geom_hline(yintercept = -log10(0.05/(length(base.segments.utest$p))), linetype = "dashed", color = "red") + theme(plot.title = element_text(hjust = 0.5))
    # Breakpoints Plot
    break.points.utest <- filter(log.metastasis.utest, cin == "break_points")
    break.points.barplot <- ggbarplot(break.points.utest,
                                       x = "project", y = "p",
                                       rotate = TRUE,
                                       xlab = "Cancer",
                                       ylab = "-Log10 p-value (M1 v. M0)",
                                       width = 0.4,
                                       sort.val = "asc",
                                       fill = "black",
                                       title = "Break Points",
                                       font.main = c(11, "bold"),
                                       font.x = c(10, "bold"),
                                       font.y = c(10, "bold"),
                                       font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(4, "bold"),) + geom_hline(yintercept = -log10(0.05/(length(break.points.utest$p))), linetype = "dashed", color = "red") + theme(plot.title = element_text(hjust = 0.5))
    # TAI bar plot
    tai.utest <- filter(log.metastasis.utest, cin == "tai")
    tai.barplot <- ggbarplot(tai.utest,
                                       x = "project", y = "p",
                                       rotate = TRUE,
                                       xlab = "Cancer",
                                       ylab = "-Log10 p-value (M1 v. M0)",
                                       width = 0.4,
                                       sort.val = "asc",
                                       fill = "black",
                                       title = "Total Aberration Index",
                                       font.main = c(11, "bold"),
                                       font.x = c(10, "bold"),
                                       font.y = c(10, "bold"),
                                       font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(4, "bold"),) + geom_hline(yintercept = -log10(0.05/(length(tai.utest$p))), linetype = "dashed", color = "red") + theme(plot.title = element_text(hjust = 0.5))
    # FGA bar plot
    fga.utest <- filter(log.metastasis.utest, cin == "fga")
    fga.barplot <- ggbarplot(fga.utest,
                                       x = "project", y = "p",
                                       rotate = TRUE,
                                       xlab = "Cancer",
                                       ylab = "-Log10 p-value (M1 v. M0)",
                                       width = 0.4,
                                       sort.val = "asc",
                                       fill = "black",
                                       title = "FGA",
                                       font.main = c(11, "bold"),
                                       font.x = c(10, "bold"),
                                       font.y = c(10, "bold"),
                                       font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(4, "bold"),) + geom_hline(yintercept = -log10(0.05/(length(fga.utest$p))), linetype = "dashed", color = "red") + theme(plot.title = element_text(hjust = 0.5))
    # CNA bar plot
    cna.utest <- filter(log.metastasis.utest, cin == "cna")
    cna.barplot <- ggbarplot(cna.utest,
                                       x = "project", y = "p",
                                       rotate = TRUE,
                                       xlab = "Cancer",
                                       ylab = "-Log10 p-value (M1 v. M0)",
                                       width = 0.4,
                                       sort.val = "asc",
                                       fill = "black",
                                       title = "Copy Number Aberrations",
                                       font.main = c(11, "bold"),
                                       font.x = c(10, "bold"),
                                       font.y = c(10, "bold"),
                                       font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(4, "bold"),) + geom_hline(yintercept = -log10(0.05/(length(cna.utest$p))), linetype = "dashed", color = "red") + theme(plot.title = element_text(hjust = 0.5))
   
     # Modified TAI bar plot
    modified.tai.utest <- filter(log.metastasis.utest, cin == "modified_tai")
    modified.tai.barplot <- ggbarplot(modified.tai.utest,
                                       x = "project", y = "p",
                                       rotate = TRUE,
                                       xlab = "Cancer",
                                       ylab = "-Log10 p-value (M1 v. M0)",
                                       width = 0.4,
                                       sort.val = "asc",
                                       fill = "black",
                                       title = "Modified Total Aberration Index",
                                       font.main = c(11, "bold"),
                                       font.x = c(10, "bold"),
                                       font.y = c(10, "bold"),
                                       font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(4, "bold"),) + geom_hline(yintercept = -log10(0.05/(length(modified.tai.utest$p))), linetype = "dashed", color = "red") + theme(plot.title = element_text(hjust = 0.5))
    
    # Combining Separate CINmetrics Plots into one Metastasis Bar Plot
    metastasis.barplot <- ggarrange(base.segments.barplot + rremove("xlab"),
                                    fga.barplot + rremove("xlab"),
                                    break.points.barplot + rremove("xlab"),
                                    cna.barplot + rremove("xlab"),
                                    tai.barplot + rremove("xlab"),
                                    modified.tai.barplot + rremove("xlab"),
                                     ncol = 1, nrow = 6)
   metastasis.barplot <- annotate_figure(metastasis.barplot, 
                    bottom = text_grob("-Log10 p-value (M1 v. M0)"))
    return(metastasis.barplot)
  }
  if(tnm.category == "node"){
    filtered.node.utest <- dplyr::filter(node.utest.df, group1 == "N0" & group2 == "N1")
    filtered.node.df <- filtered.node.utest %>% select(cin, project, group1, group2)
    # Creating a function to calculate the -log10 transformation of the p-values to input into sapply
    neglog10 <- function(x){
      neglog10 <- -log10(x)
      return(neglog10)
    }
    log.node.utest <- filtered.node.utest %>% select(p) %>% sapply(., neglog10)
    log.node.utest <- cbind(filtered.node.df, log.node.utest)
    log.node.utest$project <- str_remove(log.node.utest$project, "TCGA-")
    
    # Base Segments Plot
    base.segments.utest <- filter(log.node.utest, cin == "base_segments")
    base.segments.barplot <- ggbarplot(base.segments.utest,
                                       x = "project", y = "p",
                                       rotate = TRUE,
                                       xlab = "Cancer",
                                       ylab = "-Log10 p-value (N1 v. N0)",
                                       width = 0.4,
                                       sort.val = "asc",
                                       fill = "black",
                                       title = " ",
                                       font.main = c(11, "bold"),
                                       font.x = c(10, "bold"),
                                       font.y = c(10, "bold"),
                                       font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(4, "bold"),) + geom_hline(yintercept = -log10(0.05/(length(base.segments.utest$p))), linetype = "dashed", color = "red")
    # Breakpoints Plot
    break.points.utest <- filter(log.node.utest, cin == "break_points")
    break.points.barplot <- ggbarplot(break.points.utest,
                                       x = "project", y = "p",
                                       rotate = TRUE,
                                       xlab = "Cancer",
                                       ylab = "-Log10 p-value (N1 v. N0)",
                                       width = 0.4,
                                       sort.val = "asc",
                                       fill = "black",
                                       title = " ",
                                       font.main = c(11, "bold"),
                                       font.x = c(10, "bold"),
                                       font.y = c(10, "bold"),
                                       font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(4, "bold"),) + geom_hline(yintercept = -log10(0.05/(length(break.points.utest$p))), linetype = "dashed", color = "red")
    # TAI bar plot
    tai.utest <- filter(log.node.utest, cin == "tai")
    tai.barplot <- ggbarplot(tai.utest,
                                       x = "project", y = "p",
                                       rotate = TRUE,
                                       xlab = "Cancer",
                                       ylab = "-Log10 p-value (N1 v. N0)",
                                       width = 0.4,
                                       sort.val = "asc",
                                       fill = "black",
                                       title = " ",
                                       font.main = c(11, "bold"),
                                       font.x = c(10, "bold"),
                                       font.y = c(10, "bold"),
                                       font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(4, "bold"),) + geom_hline(yintercept = -log10(0.05/(length(tai.utest$p))), linetype = "dashed", color = "red")
    # FGA bar plot
    fga.utest <- filter(log.node.utest, cin == "fga")
    fga.barplot <- ggbarplot(fga.utest,
                                       x = "project", y = "p",
                                       rotate = TRUE,
                                       xlab = "Cancer",
                                       ylab = "-Log10 p-value (N1 v. N0)",
                                       width = 0.4,
                                       sort.val = "asc",
                                       fill = "black",
                                       title = " ",
                                       font.main = c(11, "bold"),
                                       font.x = c(10, "bold"),
                                       font.y = c(10, "bold"),
                                       font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(4, "bold"),) + geom_hline(yintercept = -log10(0.05/(length(fga.utest$p))), linetype = "dashed", color = "red")
    # CNA bar plot
    cna.utest <- filter(log.node.utest, cin == "cna")
    cna.barplot <- ggbarplot(cna.utest,
                                       x = "project", y = "p",
                                       rotate = TRUE,
                                       xlab = "Cancer",
                                       ylab = "-Log10 p-value (N1 v. N0)",
                                       width = 0.4,
                                       sort.val = "asc",
                                       fill = "black",
                                       title = " ",
                                       font.main = c(11, "bold"),
                                       font.x = c(10, "bold"),
                                       font.y = c(10, "bold"),
                                       font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(4, "bold"),) + geom_hline(yintercept = -log10(0.05/(length(cna.utest$p))), linetype = "dashed", color = "red")
   
     # Modified TAI bar plot
    modified.tai.utest <- filter(log.node.utest, cin == "modified_tai")
    modified.tai.barplot <- ggbarplot(modified.tai.utest,
                                       x = "project", y = "p",
                                       rotate = TRUE,
                                       xlab = "Cancer",
                                       ylab = "-Log10 p-value (N1 v. N0)",
                                       width = 0.4,
                                       sort.val = "asc",
                                       fill = "black",
                                       title = " ",
                                       font.main = c(11, "bold"),
                                       font.x = c(10, "bold"),
                                       font.y = c(10, "bold"),
                                       font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(4, "bold"),) + geom_hline(yintercept = -log10(0.05/(length(modified.tai.utest$p))), linetype = "dashed", color = "red")
    
    # Combining Separate CINmetrics Plots into one Node Bar Plot
    node.barplot <- ggarrange(base.segments.barplot + rremove("xlab"),
                              fga.barplot + rremove("xlab"),
                              break.points.barplot + rremove("xlab"),
                              cna.barplot + rremove("xlab"),
                              tai.barplot + rremove("xlab"),
                              modified.tai.barplot + rremove("xlab"),
                                     ncol = 1, nrow = 6)
    node.barplot <- annotate_figure(node.barplot, 
                    bottom = text_grob("-Log10 p-value (N1 v. N0)"))
    return(node.barplot)
}
}

# Creating one figure with all of the clinical variables
tumor.stage.barplot <- get_utest_graphs(tnm.category = "tumor.stage")
metastasis.barplot <-  get_utest_graphs(tnm.category = "metastasis")
node.barplot <-  get_utest_graphs(tnm.category = "node")
tnm.barplot <- ggarrange(tumor.stage.barplot,
                         metastasis.barplot,
                         node.barplot,
                           ncol = 3,
                           nrow = 1)

tnm.barplot
```


```{r}
# This function takes CINmetrics values and does a log10 transformation from the all.tnm.df and creates a strip chart categorized by tumor stage. 

#NOTE: I am still getting an error on this, so this particular code is not functional yet. There is hard code in the R chunk below of the figure I created. I am having trouble at the '# Calculating u-test data for specific cancer and metric to prepare for violin plot' part of this particular chunk. This is the error: Error in `[.data.frame`(tumor.stage.df, , j) : undefined columns selected. This error is occurring because the get_utest_data is unable to recognize the log10 column created within this function.

get_tumorstage_violinplot <- function(all.tnm.df, cancer.project, metric){
  # Subsetting by specific cancer
  cancer.tumor.stage.df <- filter(all.tnm.df, project == cancer.project) %>% filter(!(ajcc_pathologic_t %in% c("TX", "Tis", "T0")) & sample_type %in% c("Metastatic", "Primary Blood Derived Cancer", "Primary Tumor", "Recurrent Tumor", "Additional - New Primary", "Primary Blood Derived Cancer - Peripheral Blood")) %>% drop_na(ajcc_pathologic_t)
  
  # log10 transformation of CINmetric of your choice
  cancer.tumor.stage.df$log10metric <- cancer.tumor.stage.df %>% dplyr::select(metric) %>% log10()

  # Filtering subtumor stages to be under main tumor stage
  cancer.tumor.stage.df$ajcc_pathologic_t <- ifelse(cancer.tumor.stage.df$ajcc_pathologic_t %in% c("T1a", "T1a1", "T1b", "T1b2", "T1b1", "T1c"), "T1", ifelse(cancer.tumor.stage.df$ajcc_pathologic_t %in% c("T2a", "T2b", "T2c", "T2a2", "T2a1", "T2a2"), "T2", ifelse(cancer.tumor.stage.df$ajcc_pathologic_t %in% c("T3a", "T3b", "T3c"), "T3", ifelse(cancer.tumor.stage.df$ajcc_pathologic_t %in% c("T4a", "T4b", "T4c", "T4d", "T4e"), "T4", cancer.tumor.stage.df$ajcc_pathologic_t))))
  
  # Calculating u-test data for specific cancer and metric to prepare for violin plot
  cancer.tumor.stage.utest.df <- get_utest_data(cancer.tumor.stage.df, cancer.project = cancer.project, tnm.category = "tumor.stage", metrics = paste("log10metric", metric, sep = "."), file.name = paste(cancer.project, paste(metric, "tumor_stage_utest_df.csv", sep = "_"), sep = "_"))
  cancer.tumor.stage.df$ajcc_pathologic_t <- factor(filtered.brca.tumor.stage.df$ajcc_pathologic_t, levels = c("T1", "T2", "T3", "T4"))
  cancer.metric.utest.df <- cancer.tumor.stage.utest.df %>% dplyr::select(group1, group2, p) 
  
  # Adding asterisks to u-test results for figure 
cancer.metric.utest.df$p.signif <- ifelse(cancer.metric.utest.df$p <= 0.0001, paste(cancer.metric.utest.df$p,"****", sep = ""), ifelse(cancer.metric.utest.df$p <= 0.001, paste(cancer.metric.utest.df$p, "***", sep = ""), ifelse(cancer.metric.utest.df$p <= 0.01, paste(cancer.metric.utest.df$p, "**", sep = ""), ifelse(cancer.metric.utest.df$p <= 0.05, paste(cancer.metric.utest.df$p, "*",sep = ""), paste(cancer.metric.utest.df$p,"(Not Significant)", sep = " ")))))

  # Creating Violin Plot based on Tumor Stages 
  cancer.metric.violinplot <- ggviolin(cancer.metric.utest.df,
                                      x = "ajcc_pathologic_t", 
                                      y = paste("log10", metric, sep = ""),
                                      fill = "ajcc_pathologic_t", 
                                      color = "ajcc_pathologic_t", 
                                      palette = "simpsons", 
                                      size = .5, 
                                      xlab = cancer.project, 
                                      ylab = paste("log10", metric, sep = ""),
                                      alpha = .3, 
                                      title = paste(metric, "by tumor stage", sep = ""),
                                      font.main = c(11, "bold"),
                                      font.x = c(10, "bold"),
                                      font.y = c(10, "bold"),
                                      font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(7, "bold"),
                                      add = c("boxplot", "jitter"), add.params = list(size = .3, alpha = .5, fill = "white"),
                                      ) + stat_pvalue_manual(read.tumor.stage.break.points.utest.df,
                                                             y.position = 10,
                                                             step.increase = 0.1,
                                                             label = "p.signif")
  return(cancer.metric.violinplot)
}

 # Testing the function to create violin plot in breast cancer for base segments metric
brca.base.segments.violin.plot <- get_tumorstage_violinplot(all.tnm.df, cancer.project = "TCGA-BRCA", metric = "base_segments")

```



```{r}
# Takes the dataframe with the p.values from the U-test results and creates a violin plot to show the different CINmetric values based on tumor stage with significance shown. NOTE: This is the hard code I created and what I used to create the function above. 

## Comparing the p-values between each tumor stage in BRCA Base Segments and READ Break Points
# Creating figure for BRCA Base Segments

# Filtering all.tnm.df to only have breast cancer and remove samples that do not have the tumor stage data we are using
brca.tumor.stage.df <- filter(all.tnm.df, project == "TCGA-BRCA") %>% filter(!(ajcc_pathologic_t %in% c("TX", "Tis", "T0")) & sample_type %in% c("Metastatic", "Primary Blood Derived Cancer", "Primary Tumor", "Recurrent Tumor", "Additional - New Primary", "Primary Blood Derived Cancer - Peripheral Blood")) %>% drop_na(ajcc_pathologic_t)

# Log10 transformation of Base Segments Values for graphing purposes
brca.tumor.stage.df$log10base_segments <- log10(brca.tumor.stage.df$base_segments)

# Filtering to have only values more that 8 (per Vishal's request) and to categorize tumor stages by main stages
filtered.brca.tumor.stage.df <- dplyr::filter(brca.tumor.stage.df, log10base_segments >= 8)
filtered.brca.tumor.stage.df $ajcc_pathologic_t <- ifelse(filtered.brca.tumor.stage.df$ajcc_pathologic_t %in% c("T1a", "T1a1", "T1b", "T1b2", "T1b1", "T1c"), "T1", ifelse(filtered.brca.tumor.stage.df$ajcc_pathologic_t %in% c("T2a", "T2b", "T2c", "T2a2", "T2a1", "T2a2"), "T2", ifelse(filtered.brca.tumor.stage.df$ajcc_pathologic_t %in% c("T3a", "T3b", "T3c"), "T3", ifelse(filtered.brca.tumor.stage.df$ajcc_pathologic_t %in% c("T4a", "T4b", "T4c", "T4d", "T4e"), "T4", filtered.brca.tumor.stage.df$ajcc_pathologic_t))))

# Obtaining u-test p-values based on transformation and filtering for Violin Plot 
metrics <- c("tai", "modified_tai", "cna","base_segments", "break_points", "fga", "log10base_segments")
brca.tumor.stage.utest.df <- get_utest_data(filtered.brca.tumor.stage.df, cancer.project = "TCGA-BRCA", tnm.category = "tumor.stage", metrics)
filtered.brca.tumor.stage.df$ajcc_pathologic_t <- factor(filtered.brca.tumor.stage.df$ajcc_pathologic_t, levels = c("T1", "T2", "T3", "T4"))
brca.tumor.stage.base.segments.utest.df <- dplyr::filter(brca.tumor.stage.utest.df , (project == "TCGA-BRCA" & cin == "log10base_segments")) %>% select(group1, group2, p) 

# Creating a column in utest df for the asterisks based on p-value significance for Violin Plot figure 
brca.tumor.stage.base.segments.utest.df$p.signif <- ifelse(brca.tumor.stage.base.segments.utest.df$p <= 0.0001, paste(brca.tumor.stage.base.segments.utest.df$p,"****", sep = ""), ifelse(brca.tumor.stage.base.segments.utest.df$p <= 0.001, paste(brca.tumor.stage.base.segments.utest.df$p, "***", sep = ""), ifelse(brca.tumor.stage.base.segments.utest.df$p <= 0.01, paste(brca.tumor.stage.base.segments.utest.df$p, "**", sep = ""), ifelse(brca.tumor.stage.base.segments.utest.df$p <= 0.05, paste(brca.tumor.stage.base.segments.utest.df$p, "*",sep = ""), paste(brca.tumor.stage.base.segments.utest.df$p,"(Not Significant)", sep = " ")))))

# Creating Violin Plot
brca.base.segments.violin.plot <- ggviolin(filtered.brca.tumor.stage.df,
                                      x = "ajcc_pathologic_t", 
                                      y = "log10base_segments", 
                                      fill = "ajcc_pathologic_t", 
                                      color = "ajcc_pathologic_t", 
                                      palette = "simpsons", 
                                      size = .5, 
                                      xlab = "TCGA-BRCA", 
                                      ylab = "log10(Base Segments)",
                                      


                                      #yscale = "log10",
                                      #format.scale = TRUE,
                                      #position = position_jitterdodge(jitter.width = .7, jitter.height = .5, dodge.width = 0), 
                                      #rotate = FALSE,
                                      alpha = .3, 
                                      #p.adjust.method = "none",
                                      #combine = TRUE,
                                      title = "Base Segments Categorized by Tumor Stage (Filtered >8 log10(base_segments)",
                                      font.main = c(11, "bold"),
                                      font.x = c(10, "bold"),
                                      font.y = c(10, "bold"),
                                      font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(7, "bold"),
                                      #legend.title = "Tumor Stage",
                                      #font.legend = c(10, "bold"), 
                                      add = c("boxplot", "jitter"), add.params = list(size = .3, alpha = .5, fill = "white"),
                                      #add = "mean_sd", add.params = list(size = .5, alpha = 1, group = "ajcc_pathologic_t", color = "black")
                                      ) + stat_pvalue_manual(brca.tumor.stage.base.segments.utest.df,
                                                             y.position = 10,
                                                             step.increase = 0.1,
                                                             label = "p.signif")
brca.base.segments.violin.plot

# Repeating Violin Plot hard code for READ in break points 

# Filtering all.tnm.df to only have breast cancer and remove samples that do not have the tumor stage data we are using
filtered.read.tumor.stage.df <- filter(all.tnm.df, project == "TCGA-READ") %>% filter(!(ajcc_pathologic_t %in% c("TX", "Tis", "T0")) & sample_type %in% c("Metastatic", "Primary Blood Derived Cancer", "Primary Tumor", "Recurrent Tumor", "Additional - New Primary", "Primary Blood Derived Cancer - Peripheral Blood")) %>% drop_na(ajcc_pathologic_t)

# Log10 transformation of Break Points Values for graphing purposes
filtered.read.tumor.stage.df$log10break_points <- log10(filtered.read.tumor.stage.df$break_points)

# Categorizing tumor stages by main stages
filtered.read.tumor.stage.df $ajcc_pathologic_t <- ifelse(filtered.read.tumor.stage.df $ajcc_pathologic_t %in% c("T1a", "T1a1", "T1b", "T1b2", "T1b1", "T1c"), "T1", ifelse(filtered.read.tumor.stage.df $ajcc_pathologic_t %in% c("T2a", "T2b", "T2c", "T2a2", "T2a1", "T2a2"), "T2", ifelse(filtered.read.tumor.stage.df $ajcc_pathologic_t %in% c("T3a", "T3b", "T3c"), "T3", ifelse(filtered.read.tumor.stage.df $ajcc_pathologic_t %in% c("T4a", "T4b", "T4c", "T4d", "T4e"), "T4", filtered.read.tumor.stage.df$ajcc_pathologic_t))))


# Obtaining u-test p-values based on transformation and filtering for Violin Plot 
metrics <- c("tai", "modified_tai", "cna","base_segments", "break_points", "fga", "log10break_points")
read.tumor.stage.utest.df <- get_utest_data(filtered.read.tumor.stage.df, cancer.project = "TCGA-READ", tnm.category = "tumor.stage", metrics)
filtered.read.tumor.stage.df$ajcc_pathologic_t <- factor(filtered.read.tumor.stage.df$ajcc_pathologic_t, levels = c("T1", "T2", "T3", "T4"))
read.tumor.stage.break.points.utest.df <- dplyr::filter(read.tumor.stage.utest.df , (project == "TCGA-READ" & cin == "log10break_points")) %>% select(group1, group2, p) 

# Creating a column in utest df for the asterisks based on p-value significance for Violin Plot figure 
read.tumor.stage.break.points.utest.df$p.signif <- ifelse(read.tumor.stage.break.points.utest.df$p <= 0.0001, paste(read.tumor.stage.break.points.utest.df$p,"****", sep = ""), ifelse(read.tumor.stage.break.points.utest.df$p <= 0.001, paste(read.tumor.stage.break.points.utest.df$p, "***", sep = ""), ifelse(read.tumor.stage.break.points.utest.df$p <= 0.01, paste(read.tumor.stage.break.points.utest.df$p, "**", sep = ""), ifelse(read.tumor.stage.break.points.utest.df$p <= 0.05, paste(read.tumor.stage.break.points.utest.df$p, "*",sep = ""), paste(read.tumor.stage.break.points.utest.df$p,"(Not Significant)", sep = " ")))))

# Creating Violin Plot
read.break.points.violin.plot <- ggviolin(filtered.read.tumor.stage.df,
                                      x = "ajcc_pathologic_t", 
                                      y = "log10break_points", 
                                      fill = "ajcc_pathologic_t", 
                                      color = "ajcc_pathologic_t", 
                                      palette = "simpsons", 
                                      size = .5, 
                                      xlab = "TCGA-READ", 
                                      ylab = "log10(Break Points)",
                                      


                                      #yscale = "log10",
                                      #format.scale = TRUE,
                                      #position = position_jitterdodge(jitter.width = .7, jitter.height = .5, dodge.width = 0), 
                                      #rotate = FALSE,
                                      alpha = .3, 
                                      #p.adjust.method = "none",
                                      #combine = TRUE,
                                      title = "Break Points Categorized by Tumor Stage",
                                      font.main = c(11, "bold"),
                                      font.x = c(10, "bold"),
                                      font.y = c(10, "bold"),
                                      font.xtickslab = c(10, "bold"),
                                      font.ytickslab = c(7, "bold"),
                                      #legend.title = "Tumor Stage",
                                      #font.legend = c(10, "bold"), 
                                      add = c("boxplot", "jitter"), add.params = list(size = .3, alpha = .5, fill = "white"),
                                      #add = "mean_sd", add.params = list(size = .5, alpha = 1, group = "ajcc_pathologic_t", color = "black")
                                      ) + stat_pvalue_manual(read.tumor.stage.break.points.utest.df,
                                                             y.position = 10,
                                                             step.increase = 0.1,
                                                             label = "p.signif")
read.break.points.violin.plot





```

